<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xml:lang=
"en-US">
<head>
<title>Design of Shutdown Hooks API</title>

<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/pubs8/js/popUp.js"></script>
<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/pubs8/js/sniff.js"></script>
<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/pubs8/js/menucontent.js"></script>
<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/pubs8/js/menucode.js"></script>
<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/pubs8/js/developer.js"></script>
<script language="javascript1.2" type="text/javascript" src="../../../../../webdesign/other/js/search.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../../webdesign/pubs8/css/default_developer.css" />
<meta name="collection" content="reference"/> 
<script>window.ohcglobal || document.write('<script src="/en/dcommon/js/global.js">\x3C/script>')</script></head>
<body>
<noscript>JavaScript is not supported by your browser. JavaScript
support is required for full functionality of this page.</noscript>
<div class="a0 a0v1" id="a0v1"><!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1 a1r2">
<div class="a1v0"><a href="#skip2content" class="skiplink">Skip to
Content</a></div>
</div>
<!-- END A1 COMPONENT V.0 -->
<!-- BEGIN A2 COMPONENT V.1 -->
<div class="a2w0">
<div class="a2" id="a2v1">
<div class="a2w1">
<div class="a2w2">
<div class="a2w3">
<div class="a2w4">
<div class="a2topiclinks"><a href="http://www.oracle.com" title=
"Oracle Home Page" id="sunlogo" name="sunlogo"><img src=
"../../../../../webdesign/pubs8/im/a.gif" alt="Home Page" width="98" height="58"
border="0" /></a>
<ul id="mtopics">
<li id="mtopic1"><a id="glink1" class="tpclink a2menu" title=
"See Oracle Technology Network" href="http://oracle.com/technology"
name="glink1">Oracle Technology Network</a></li>
<li id="mtopic2"><a id="glink2" class="tpclink a2menu" title=
"Software Downloads" href=
"http://www.oracle.com/technology/software/index.html" name=
"glink2">Software Downloads</a></li>
<li id="mtopic3"><a id="glink3" class="tpclink a2menu" title=
"See Java SE Documentation" href=
"http://docs.oracle.com/javase/index.html" name=
"glink3">Documentation</a></li>
</ul>
<div class="a2search"><a href="../../../../../search.html" target=
"_blank">Search</a></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- END A2 COMPONENT V.1 -->
<!-- BEGIN SEPARATOR -->
<div class="hr">
<hr /></div>
<!-- END SEPARATOR -->
<!-- ============ -->
<!-- MAIN CONTENT -->
<!-- ============ -->
<a name="skip2content" id="skip2content"></a>



<div class="smallpagetitle"><h1>Design of the Shutdown Hooks API</h1></div>

The following Q&amp;A addresses some of the design issues of the
Shutdown Hooks API.

<p><b>Why don't you provide information as to why the VM is
shutting down?</b></p>
On some platforms a native process can't distinguish a shutdown due
to exit from a shutdown due to termination. Other platforms provide
much richer capabilities, in some cases including notification of
system suspension and restart or of imminent power failure. In
short, it's impossible to generalize such information in a portable
way.
<p><b>Will shutdown hooks be run if the VM crashes?</b></p>
If the VM crashes due to an error in native code then no guarantee
can be made about whether or not the hooks will be run.
<p><b>Why are shutdown hooks run concurrently? Wouldn't it make
more sense to run them in reverse order of registration?</b></p>
Invoking shutdown hooks in their reverse order of registration is
certainly intuitive, and is in fact how the C runtime library's
<tt>atexit</tt> procedure works. This technique really only makes
sense, however, in a single-threaded system. In a multi-threaded
system such as Java platform the order in which hooks are
registered is in general undetermined and therefore implies nothing
about which hooks ought to be run before which other hooks.
Invoking hooks in any particular sequential order also increases
the possibility of deadlocks. Note that if a particular subsystem
needs to invoke shutdown actions in a particular order then it is
free to synchronize them internally.
<p><b>Why are hooks just threads, and unstarted ones at that?
Wouldn't it be simpler to use <tt>Runnable</tt> objects, or
Beans-style event and listener patterns?</b></p>
The approach taken here has two advantages over the more obvious,
and more frequently suggested, callback-oriented designs based upon
<tt>Runnable</tt> objects or Beans-style event listeners.
<p>First, it gives the user complete control over the thread upon
which a shutdown action is executed. The thread can be created in
the proper thread group, given the correct priority, context, and
privileges, and so forth.</p>
<p>Second, it simplifies both the specification and the
implementation by isolating the VM from the hooks themselves. If
shutdown actions were executed as callbacks then a robust
implementation would wind up having to create a separate thread for
each hook anyway in order for them to run concurrently. The
specification would also have to include explicit language about
how the threads that execute the callbacks are created.</p>
<p><b>Aren't threads pretty expensive things to keep around,
especially if they won't be started until the VM shuts
down?</b></p>
Most implementations of the Java platform don't actually allocate
resources to a thread until it's started, so maintaining a set of
unstarted threads is actually very cheap. If you look at the
internals of <tt>java.lang.Thread</tt> you can see that its various
constructors just do security checks and initialize private fields.
The native <tt>start()</tt> method does the real work of allocating
a thread stack, etc., to get things going.
<p><b>What about Personal and Embedded Java? Won't starting threads
during shutdown be too expensive on those platforms?</b></p>
This API may not be suitable for the smaller Java platforms.
Threads in the Java 2 Platform carry more information than threads
in JDK 1.1 and p/eJava. A thread has a class loader, it may have
some inherited thread-local variables, and, in the case of GUI
apps, it may be associated with a specific application context.
Threads will come to carry even more information as the platform
evolves; for example, the security team is planning to introduce a
notion of per-thread user identity in their upcoming authentication
framework.
<p>Because of all this contextual information, shutdown hooks would
be harder to write and maintain if they were just <tt>Runnable</tt>
objects or Beans-style event listeners. Suppose that a
<tt>Runnable</tt> shutdown hook, or an equivalent event listener,
needed a specific bit of thread-contextual information in order to
carry out its operations. Such information could be saved in some
shared location before the hook is registered. While this is merely
awkward, suppose further that threads acquire some new type of
contextual information in a future release. If an operation invoked
by the hook also evolves to need that information then the code
that registers the hook would have to be amended to save that
information as well. Making hooks be threads instead of
<tt>Runnable</tt>s or event listeners insulates them from this sort
of future change.</p>
<p><b>Okay, but won't I have to write a lot of code just to
register a simple shutdown hook?</b></p>
No. Simple shutdown hooks can often be written as anonymous inner
classes, as in this example:
<pre class="codeblock">
Runtime.getRuntime().addShutdownHook(new Thread() {
    public void run() { database.close(); }
});
</pre>
This idiom is fine as long as you'll never need to cancel the hook,
in which case you'd need to save a reference to the hook when you
create it.
<p><b>What about security? Can an untrusted applet register a
shutdown hook?</b></p>
If there is a security manager installed then the
<tt>addShutdownHook</tt> and <tt>removeShutdownHook</tt> methods
check that the caller's security context permits
<tt>RuntimePermission("shutdownHooks")</tt>. An untrusted applet
will not have this permission, and will therefore not be able to
register or de-register a shutdown hook.
<p><b>What happens if a shutdown hook throws an exception and the
exception is not caught?</b></p>
Uncaught exceptions are handled in shutdown hooks just as in any
other thread, by invoking the <tt>uncaughtException</tt> method of
the thread's <tt>ThreadGroup</tt> object. The default
implementation of this method prints the exception's stack trace to
<tt>System.err</tt> and terminates the thread. Note that uncaught
exceptions do not cause the VM to exit; this happens only when all
non-daemon threads have finished or when the <tt>Runtime.exit</tt>
method is invoked.
<p><b>Why did you add the <tt>Runtime.halt</tt> method? Isn't it
pretty dangerous?</b></p>
The <!--new--><tt>halt</tt> method is certainly powerful, and it should
be used with the utmost caution. It's provided so that applications
can insulate themselves from shutdown hooks that deadlock or run
for inordinate amounts of time. It also allows applications to
force a quick exit in situations where that is necessary.
<p><b>What happens if finalization-on-exit is enabled? Will
finalizers be run before, during, or after shutdown hooks?</b></p>
Finalization-on-exit processing is done after all shutdown hooks
have finished. Otherwise a hook may fail if some live objects are
finalized prematurely. <!-- Body text ends here -->

<div id="javasefooter">
<div class="hr">
<hr /></div>
<div id="javasecopyright">
<a href="../../../legal/cpyr.html">Copyright &#169;</a> 1993, 2018, Oracle
and/or its affiliates. All rights reserved.
</div>

<div id="javasecontactus">
<a href="http://docs.oracle.com/javase/feedback.html">Contact Us</a>
</div>
</div>
</div>

<!-- Start SiteCatalyst code -->
<script type="application/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_docs.js"></script>
<!-- End SiteCatalyst code -->

</body>
</html>
