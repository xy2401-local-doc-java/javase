<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xml:lang=
"en-US">
<head>
<!-- GenHTML revision 23965-->
<meta http-equiv="Content-type" content=
"text/html; charset=utf-8" />
<title>Java 2D - Troubleshooting Guide for Java SE 7 Desktop
Technologies</title>
<meta http-equiv="content-language" content="en-US" />
<meta name="robots" content="index,follow" />
<meta name="language" content="en" />
<meta name="collection" content="reference" />
<meta name="keywords" content="" />
<meta name="description" content=
"This document is a guide to help troubleshoot problems that might arise with applications that are deployed using the release of Java Platform, Standard Edition 7 (Java SE 7). Most of the information also applies to Java SE 5." />
<meta name="date" content="2008-09-01" />
<link rel="stylesheet" type="text/css" title="screen" href=
"css/default.css" />
<link rel="stylesheet" type="text/css" title="screen" href=
"css/pagelayout.css" />
<link rel="alternate stylesheet" type="text/css" title="print"
href="css/print.css" />
<script type="text/javascript">
//<![CDATA[
function setActiveStyleSheet(title) {
  var i, a, main;
  for (i=0; (a = document.getElementsByTagName("link")[i]); i++) {
         if (a.getAttribute("rel").indexOf("style") != -1 && a.getAttribute("title")) {
                a.disabled = true;
                if(a.getAttribute("title") == title) a.disabled = false;
         }
  }
}

function ClearDefault(Element) {
   if (Element.defaultValue == Element.value) {
        Element.value = ""
        Element.style.cssText = "font-weight: bold; color: #00000"
   }
}

//]]>
</script>
<script>window.ohcglobal || document.write('<script src="/en/dcommon/js/global.js">\x3C/script>')</script></head>
<body>
<div class="MastheadPane">
<table class="MastheadTable" width="100%">
<tr class="closeprintview">
<td align="right"><a href="#" onclick=
"setActiveStyleSheet('screen')">Exit Print View</a></td>
</tr>
<tr class="titlebar">
<td>
<h4 class="contentpage-doctitle"><a href="toc.html">Troubleshooting
Guide for Java SE 7 Desktop Technologies</a></h4>
</td>
<td class="smallLogo"><a href="http://www.oracle.com"><img src=
"graphics/smallOracleLogo.gif" /></a></td>
</tr>
</table>
</div>
<div class="ButtonPane">
<table class="pagecontrol">
<tr>
<td class="pagebuttons"><a href="#" onclick=
"setActiveStyleSheet('print')"><img height="46" width="40" border=
"0" src="graphics/print.gif" alt="Print View" title=
"Print View" /></a></td>
<td class="pagebreadcrumb"></td>
<td class="pagenavlinks"><a href="awt.html"><img src=
"graphics/leftButton.gif" border="0" alt="Previous" title=
"Previous" /></a> <a href="swing.html"><img src=
"graphics/rightButton.gif" border="0" alt="Next" title=
"Next" /></a></td>
</tr>
</table>
</div>
<div class="TOCPane">
<p class="toc level1"><a href="docinfo.html">Document
Information</a></p>
<p class="toc level1 tocsp"><a href="preface.html">Preface</a></p>
<p class="toc level1 tocsp"><a href=
"introduction.html">1.&#160;&#160;Introduction</a></p>
<p class="toc level1 tocsp"><a href=
"awt.html">2.&#160;&#160;AWT</a></p>
<div id="scrolltoc" class="onpage">
<p class="toc level1 tocsp"><a href="">3.&#160;&#160;Java
2D</a></p>
<p class="toc level2"><a href="#gcghe">3.1 Changing Rendering
Pipelines and Their Properties</a></p>
<p class="toc level3"><a href="#gcghm">3.1.1 Solaris OS and Linux:
Using Default X11 Pipeline</a></p>
<p class="toc level4"><a href="#gcgiv">3.1.1.1 Properties Related
to the Use of X11 Pixmaps</a></p>
<p class="toc level5"><a href="#gdkuc">Disabling the Use of Pixmaps
by the X11 Pipeline</a></p>
<p class="toc level5"><a href="#gdkug">Disabling/Forcing the Use of
Shared Memory Pixmaps by the X11 Pipeline</a></p>
<p class="toc level4 tocsp"><a href="#gcgjs">3.1.1.2 Use of MIT
Shared Memory Extension by the X11 Pipeline</a></p>
<p class="toc level5"><a href="#gdkti">Increasing Shared Memory
Available to X Server and Java 2D</a></p>
<p class="toc level5"><a href="#gdkts">Disabling Use of Shared
Memory Extension by the X11 Pipeline</a></p>
<p class="toc level4 tocsp"><a href="#gcgkf">3.1.1.3 Solaris OS on
SPARC: Use of DGA in Certain Configurations</a></p>
<p class="toc level5"><a href="#gdksw">Detecting Use of DGA
Extension for Rendering to Screen</a></p>
<p class="toc level5"><a href="#gdkue">Typical Issues Caused by Use
of DGA</a></p>
<p class="toc level5"><a href="#gdktz">Controlling Use of DGA by
Java 2D</a></p>
<p class="toc level3 tocsp"><a href="#gdkto">3.1.2 Solaris OS on
SPARC: Changing Default Visual Used by Java 2D</a></p>
<p class="toc level3"><a href="#gcgtf">3.1.3 Windows OS: Using
Default DirectDraw/GDI Pipeline</a></p>
<p class="toc level4"><a href="#gcgrz">3.1.3.1 Disabling the Use of
DirectDraw</a></p>
<p class="toc level4"><a href="#gcgrw">3.1.3.2 Forcing the Use of
DirectDraw Pipeline</a></p>
<p class="toc level4"><a href="#gcgtx">3.1.3.3 Disabling the
Built-in Punting Mechanism</a></p>
<p class="toc level4"><a href="#gcgsz">3.1.3.4 Disabling the
DirectDraw Blit Operations</a></p>
<p class="toc level3 tocsp"><a href="#gcgsi">3.1.4 Windows OS:
Using Direct3D Pipeline (Full-Screen Mode)</a></p>
<p class="toc level4"><a href="#gcgsp">3.1.4.1 Disabling the
Direct3D Pipeline</a></p>
<p class="toc level4"><a href="#gcgsn">3.1.4.2 Forcing the Use of
the Direct3D Pipeline</a></p>
<p class="toc level4"><a href="#gcgtn">3.1.4.3 Diagnosing Rendering
Problems with Direct3D Pipeline</a></p>
<p class="toc level3 tocsp"><a href="#gcgto">3.1.5 Using OpenGL
Pipeline (SolarisOS, Linux, and Windows)</a></p>
<p class="toc level4"><a href="#gdpji">3.1.5.1 Enabling the OpenGL
Pipeline</a></p>
<p class="toc level4"><a href="#gdpie">3.1.5.2 Minimum
Requirements</a></p>
<p class="toc level4"><a href="#gdphy">3.1.5.3 Latest OpenGL
Drivers</a></p>
<p class="toc level4"><a href="#gdpit">3.1.5.4 Diagnosing Startup
Issues</a></p>
<p class="toc level4"><a href="#gdpio">3.1.5.5 Diagnosing Rendering
and Performance Issues</a></p>
<p class="toc level2 tocsp"><a href="#gcrua">3.2 Generic
Performance Issues</a></p>
<p class="toc level3"><a href="#gcrtt">3.2.1 Hardware Accelerated
Rendering Primitives</a></p>
<p class="toc level3"><a href="#gcrus">3.2.2 Using Java 2D
Primitive Tracing to Detect and Avoid Non-accelerated
Rendering</a></p>
<p class="toc level3"><a href="#gduem">3.2.3 Causes of Poor
Rendering Performance</a></p>
<p class="toc level4"><a href="#gcrvb">3.2.3.1 Mixing Accelerated
and Non-accelerated Rendering</a></p>
<p class="toc level4"><a href="#gcrvp">3.2.3.2 Using Non-optimal
Rendering Primitives</a></p>
<p class="toc level4"><a href="#gcrvj">3.2.3.3 Using Heap-based
Destination Surface (a <tt>BufferedImage</tt>)</a></p>
<p class="toc level4"><a href="#gcrwz">3.2.3.4 Defeating Built-in
Acceleration Mechanisms</a></p>
<p class="toc level5"><a href="#gcrwq">Getting Direct Access to the
Pixels with <tt>getDataBuffer()</tt></a></p>
<p class="toc level5"><a href="#gcrvk">Rendering to a Sprite Before
Every Copy</a></p>
<p class="toc level5"><a href="#gcrvt">Exhausting Accelerated
Memory Resources</a></p>
<p class="toc level3 tocsp"><a href="#gcrwc">3.2.4 Improving
Performance of Software-only Rendering</a></p>
<p class="toc level4"><a href="#gcrws">3.2.4.1 Use of Image Types
or Operations With Optimized Support</a></p>
<p class="toc level4"><a href="#gcrwh">3.2.4.2 Transparency vs
Translucency</a></p>
<p class="toc level2 tocsp"><a href="#gdlvo">3.3 Text-Related
Issues</a></p>
<p class="toc level3"><a href="#gdlwj">3.3.1 Application Crash
During Text Rendering</a></p>
<p class="toc level3"><a href="#gdlwn">3.3.2 Differences in Text
Appearance</a></p>
<p class="toc level3"><a href="#gdpin">3.3.3 Metrics</a></p>
<p class="toc level2 tocsp"><a href="#gceyw">3.4 Java 2D
Printing</a></p>
</div>
<p class="toc level1 tocsp"><a href=
"swing.html">4.&#160;&#160;Swing</a></p>
<p class="toc level1 tocsp"><a href=
"i18n.html">5.&#160;&#160;Internationalization</a></p>
<p class="toc level1 tocsp"><a href="sound.html">6.&#160;&#160;Java
Sound</a></p>
<p class="toc level1 tocsp"><a href=
"plugin.html">7.&#160;&#160;Applets and Java Web Start
Applications</a></p>
<p class="toc level1 tocsp"><a href=
"bugreports.html">8.&#160;&#160;Submitting Bug Reports</a></p>
<p class="toc level1 tocsp"><a href=
"java2d-props.html">A.&#160;&#160;Java 2D Properties</a></p>
<p class="toc level1 tocsp"><a href=
"felog.html">B.&#160;&#160;Fatal Error Log</a></p>
</div>
<div class="ContentPane"><a name="java2d" id=
"java2d"></a>Chapter&#160;3
<h2>Java 2D</h2>
<p>This chapter provides information and guidance for
troubleshooting some of the most common issues that might be found
in the Java 2D API, included in the following sections:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcghe">3.1 Changing Rendering Pipelines and Their
Properties</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrua">3.2 Generic Performance Issues</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gdlvo">3.3 Text-Related Issues</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gceyw">3.4 Java 2D Printing</a></p>
</li>
</ul>
<p>See <img class="linkicon" src="graphics/linkicon.gif" /><a href=
"java2d-props.html">Appendix&#160;A, Java 2D Properties</a> for a
summary of Java 2D properties.</p>
<p>See also the <a href=
"http://www.oracle.com/technetwork/java/index-137037.html">Java 2D
FAQ</a>.</p>
<a name="gcghe" id="gcghe"></a>
<h3>3.1 Changing Rendering Pipelines and Their Properties</h3>
<p>Java 2D uses a set of pipelines, which can be roughly defined as
different ways of rendering the primitives. These pipelines are as
follows:</p>
<ul>
<li>
<p>X11 pipeline, which is the default for Solaris OS and Linux</p>
</li>
<li>
<p>OpenGL pipeline, which is an alternative on Solaris OS and
Linux, as well as Windows</p>
</li>
<li>
<p>DirectDraw/GDI pipeline, which is the default on Windows</p>
</li>
<li>
<p>Direct3D pipeline, which is an alternative on Windows</p>
</li>
</ul>
<p>By choosing a different pipeline, or manipulating the properties
of a pipeline, you might be able to determine the cause of the
problem, and often find a workaround.</p>
<p>The following procedure can help you troubleshoot Java 2D
issues:</p>
<ol>
<li>
<p>Determine the default pipeline used in your configuration.</p>
</li>
<li>
<p>Either change the pipeline to another one, or modify the
properties of the default pipeline.</p>
</li>
<li>
<p>If the problem disappears, you have found a workaround.</p>
</li>
<li>
<p>If the problem persists, try changing another property or
pipeline.</p>
</li>
</ol>
<p>This section describes how to change the Java 2D pipelines and
their properties for each operating system: UNIX (Solaris OS and
Linux), and Windows.</p>
<p>For the default X11 pipeline on Solaris OS and Linux, the
following information is provided:</p>
<ul>
<li>
<p>Properties related to the use of X11 pixmaps</p>
<ul>
<li>
<p>Disabling the use of pixmaps by the X11 pipeline</p>
</li>
<li>
<p>Disabling/forcing the use of shared memory pixmaps by the X11
pipeline</p>
</li>
</ul>
</li>
<li>
<p>Use of Shared Memory Extension by the X11 pipeline</p>
<ul>
<li>
<p>Increasing the amount of shared memory available to X server and
Java 2D</p>
</li>
<li>
<p>Disabling the use of Shared Memory Extension by the X11
pipeline</p>
</li>
</ul>
</li>
<li>
<p>Solaris OS on SPARC: use of DGA in certain configurations</p>
<ul>
<li>
<p>Detecting if the DGA extension is used for rendering to the
screen</p>
</li>
<li>
<p>Typical issues caused by the use of DGA</p>
</li>
<li>
<p>Controlling the use of DGA by Java 2D</p>
</li>
</ul>
</li>
<li>
<p>Solaris OS on SPARC: changing the default visual used by Java
2D</p>
</li>
</ul>
<p>For the default DirectDraw/GDI pipeline on Windows, the
following information is provided:</p>
<ul>
<li>
<p>Disabling the use of DirectDraw</p>
</li>
<li>
<p>Forcing the use of DirectDraw pipeline</p>
</li>
<li>
<p>Disabling the built-in punting mechanism</p>
</li>
<li>
<p>Disabling the use of DirectDraw blit operations</p>
</li>
</ul>
<p>For the alternative Direct3D pipeline on Windows, the following
information is provided:</p>
<ul>
<li>
<p>Disabling the Direct3D pipeline</p>
</li>
<li>
<p>Forcing the use of the Direct3D pipeline</p>
</li>
<li>
<p>Diagnosing rendering problems with the Direct3D pipeline</p>
</li>
</ul>
<p>This section also provides information on using the OpenGL
pipeline as an alternative pipeline on Solaris OS, Linux, and
Windows.</p>
<a name="gcghm" id="gcghm"></a>
<h4>3.1.1 Solaris OS and Linux: Using Default X11 Pipeline</h4>
<p>On Unix platforms the default pipeline is the X11 pipeline. This
pipeline uses the X protocol for rendering to the screen or to
certain types of offscreen images, such as <tt>VolatileImages</tt>,
or &#8220;compatible&#8221; images (images that are created with
the <tt>GraphicsConfiguration.createCompatibleImage()</tt> method).
Such types of images can be put into X11 pixmaps for improved
performance, especially in the case of the Remote X server.</p>
<p>In addition, in certain cases Java 2D uses X server extensions,
for example, the MIT X shared memory extension, or Direct Graphics
Access extension, Double-buffer extension for double-buffering when
using the <tt>BufferStrategy</tt> API.</p>
<p>An additional pipeline, the OpenGL pipeline, might offer greater
performance in some configurations.</p>
<a name="gcgiv" id="gcgiv"></a>
<h5>3.1.1.1 Properties Related to the Use of X11 Pixmaps</h5>
<p>Java 2D by default uses X11 pixmaps for storing or caching
certain types of offscreen images. Only the following types of
images can be stored in pixmaps:</p>
<ul>
<li>
<p>Opaque images, in which case
<tt>ColorModel.getTransparency()</tt> returns
<tt>Transparency.OPAQUE</tt></p>
</li>
<li>
<p>1-bit transparent images (also known as sprites,
<tt>Transparency.BITMASK</tt>)</p>
</li>
</ul>
<p>The advantage of using pixmaps for storing images is that they
can be put into the framebuffer's Video memory at the driver's
discretion, which improves the speed at which these pixmaps can be
copied to the screen or another pixmap.</p>
<p>The use of pixmaps typically results in better performance.
However, in certain cases, the opposite is true. Such cases
typically involve the use of operations which cannot be performed
using the X protocol, such as antialiasing, alpha compositing, and
transforms that are more complex than simple translation
transforms.</p>
<p>For these operations the X11 pipeline must do the rendering
using the built-in software renderer. In most cases this includes
reading the contents of the pixmap to a system memory (over the
network in the case of remote X server), performing the rendering,
and then sending the pixels back to the pixmap. Such operations
could result in extremely poor performance, especially if the X
server is remote.</p>
<a name="gdkuc" id="gdkuc"></a>
<h5>Disabling the Use of Pixmaps by the X11 Pipeline</h5>
<p>To disable the use of pixmaps by Java2D, pass the following
property to the Java VM:
<tt>-Dsun.java2d.pmoffscreen=false</tt>.</p>
<a name="gdkug" id="gdkug"></a>
<h5>Disabling/Forcing the Use of Shared Memory Pixmaps by the X11
Pipeline</h5>
<p>To minimize the effect of such operations requiring reading of
pixels from a pixmap on overall performance, the X11 pipeline uses
shared memory pixmaps for storing images which are often read from.
Note that the shared memory pixmaps can only be used in the case of
a local X server.</p>
<p>The advantage of using shared memory pixmaps is that the
pipeline can get direct access to the pixels in the pipeline
bypassing the X11 protocol, which results in better
performance.</p>
<p>By default an image is stored in a normal X server pixmap, but
it can be later moved to a shared memory pixmap if the pipeline
detects excessive reading from such an image. The image can be
moved back to a server pixmap if it is copied from often
enough.</p>
<p>The pipeline allows two ways of controlling the use of shared
memory pixmaps: either disablng them, or forcing all images to be
always stored in shared memory pixmaps.</p>
<ul>
<li>
<p>To disable shared memory pixmaps, set the <tt>J2D_PIXMAPS</tt>
environment variable to <tt>server</tt>. This is the default in
remote X server case.</p>
</li>
<li>
<p>To force all pixmaps to be created in shared memory, set
<tt>J2D_PIXMAPS</tt> to <tt>shared</tt>.</p>
</li>
</ul>
<p>First try forcing the shared memory pixmaps, as it is often
improves performance. However, with certain video board/driver
configurations it may be necessary to disable the shared memory
pixmaps to avoid rendering artifacts or crashes.</p>
<a name="gcgjs" id="gcgjs"></a>
<h5>3.1.1.2 Use of MIT Shared Memory Extension by the X11
Pipeline</h5>
<p>The Java 2D X11 pipeline uses by default the MIT Shared Memory
Extension (MIT SHM). This extension allows a faster exchange of
data between the client (the Java application) and the X server,
and this can significantly improve the performance of Java
applications.</p>
<a name="gdkti" id="gdkti"></a>
<h5>Increasing Shared Memory Available to X Server and Java 2D</h5>
<p>On Solaris OS releases 8 and earlier it was sometimes necessary
to increase the amount of shared memory available to the system
(and to X server in particular) as the default was too low,
resulting in poor rendering performance. Increasing the amount of
shared memory and shared memory segments can result in better
performance.</p>
<p>To change the default settings on Solaris OS, edit the
<tt>/etc/system</tt> file, changing the <tt>shmsys:shminfo_*</tt>
settings, as in the following example. Note that this is not needed
on Solaris 9 OS and newer.</p>
<pre>
set shmsys:shminfo_shmmax=10000000
set shmsys:shminfo_shmni=200
set shmsys:shminfo_shminfo=150
</pre>
<p>On Linux this setting can be configured by editing the
<tt>/proc/sys/kernel/shm*</tt> files.</p>
<a name="gdkts" id="gdkts"></a>
<h5>Disabling Use of Shared Memory Extension by the X11
Pipeline</h5>
<p>In case of problems (such as crashes, or rendering artifacts)
with older X servers and Shared Memory Extension, it is useful to
be able to disable the extension. To disable the use of MIT SHM,
set the <tt>J2D_USE_MITSHM</tt> environment variable to
<tt>false</tt>.</p>
<a name="gcgkf" id="gcgkf"></a>
<h5>3.1.1.3 Solaris OS on SPARC: Use of DGA in Certain
Configurations</h5>
<p>On SPARC hardware, if the framebuffer supports Sun's DGA (Direct
Graphics Access) X server extension, and Java 2D has a
corresponding module for accessing the framebuffer, DGA will be
used for rendering to the screen.</p>
<p>All offscreen images will reside in Java heap memory, and Java
2D's software-only rendering pipeline is used for rendering to
them. This is different from a typical UNIX configuration, where
X11 pixmaps are used for offscreen images.</p>
<a name="gdksw" id="gdksw"></a>
<h5>Detecting Use of DGA Extension for Rendering to Screen</h5>
<p>To detect if the DGA extension is used for rendering ot the
screen, run any Java application which does some rendering or
displays a GUI, and check if a <tt>/tmp/wg*</tt> file was created
when the application started. Exit the application and verify that
the file has been deleted. If this is the case, then on this system
Java 2D is using DGA.</p>
<a name="gdkue" id="gdkue"></a>
<h5>Typical Issues Caused by Use of DGA</h5>
<p>Since DGA allows direct access to the framebuffer's video
memory, the typical problems include corruption outside of window
bounds, complete system, and X server lock-ups.</p>
<a name="gdktz" id="gdktz"></a>
<h5>Controlling Use of DGA by Java 2D</h5>
<p>If it is determined that DGA is being used, the first thing to
try is to disable it. This can be done by setting the
<tt>NO_J2D_DGA</tt> environment variable to <tt>true</tt>. This
forces the default UNIX path to use only X11 for rendering to the
screen, and pixmaps for accelerating offscreen images.</p>
<p>In some cases it could be beneficial to enable the use of
pixmaps, while also using DGA for rendering to the screen. To force
the use of pixmaps for accelerating offscreen images, set the
following property when starting the application:
<tt>-Dsun.java2d.pmoffscreen=true</tt>.</p>
<a name="gdkto" id="gdkto"></a>
<h4>3.1.2 Solaris OS on SPARC: Changing Default Visual Used by Java
2D</h4>
<p>On certain video boards on the SPARC platform, more than one
visual can be available from the X server. By default Java 2D tries
to select the best visual, where &#8220;best&#8221; is typically a
higher-bit depth visual. For example, on some Solaris OS releases
the default X11 visual is 8-bit PseudoColor, although 24-bit visual
is also available. In such cases Java 2D will select a 24-bit
TrueColor visual as the default for Java windows.</p>
<p>While it is possible to create a Java top-level window with a
<tt>GraphicsConfiguration</tt> object corresponding to a different
visual, in some cases it is necessary to make Java use a different
default visual instead. This can be done by setting the
<tt>FORCEDEFVIS</tt> environment variable. It can be set to
<tt>true</tt> to force the use of the default X server visual (even
if it is not the best one), or it can be set to a hexadecimal
number corresponding to the visual ID as reported by tools like
<tt>xdpyinfo</tt>.</p>
<p>To determine your X server default visual, execute the
<tt>xdpyinfo</tt> command and look at the <tt>default visual
id</tt> field.</p>
<a name="gcgtf" id="gcgtf"></a>
<h4>3.1.3 Windows OS: Using Default DirectDraw/GDI Pipeline</h4>
<p>The default pipeline on the Windows platform is a mixture of the
DirectDraw pipeline and the GDI pipeline, where some operations are
performed with the DirectDraw pipeline and others with the GDI
pipeline. DirectDraw and GDI APIs are used for rendering to
accelerated offscreen and onscreen surfaces.</p>
<p>Starting with the Java SE 6 release, when the application enters
full-screen mode, the new Direct3D pipeline can be used, if the
drivers satisfy the requirements. Possible issues with the Direct3D
pipeline include rendering artifacts, crashes, and
performance-related problems.</p>
<p>An additional pipeline, the OpenGL pipeline, might offer greater
performance in some configurations.</p>
<a name="gcgrz" id="gcgrz"></a>
<h5>3.1.3.1 Disabling the Use of DirectDraw</h5>
<p>When DirectDraw is disabled, all operations are performed with
GDI. Provide the following flag to disable the use of DirectDraw:
<tt>-Dsun.java2d.noddraw=true</tt>. In this case all offscreen
images will be created in the Java heap, and rendered to with the
default software pipeline. All onscreen rendering, as well as
copies of offscreen images to the screen will be performed using
GDI.</p>
<a name="gcgrw" id="gcgrw"></a>
<h5>3.1.3.2 Forcing the Use of DirectDraw Pipeline</h5>
<p>In case the pipeline was disabled by default for some reason, it
can be enabled by providing the <tt>-Dsun.java2d.noddraw=false</tt>
flag to the VM.</p>
<p>However, typically there was a reason why it was disabled in the
first place, so it is better not to force it.</p>
<a name="gcgtx" id="gcgtx"></a>
<h5>3.1.3.3 Disabling the Built-in Punting Mechanism</h5>
<p>In general, the DirectDraw pipeline attempts to place the
offscreen surfaces in the framebuffer's video memory, which
provides fast copies from these surfaces to the screen or other
accelerated surfaces, as well as hardware accelerated rendering of
certain graphics operations.</p>
<p>However, if the pipeline cannot perform an operation using the
DirectDraw API (operations using, for example, alpha compositing,
or transforms, or antialiasing), the rendering is performed using
the software pipeline. In some cases this means that the pixels of
the destination surface, which resides in VRAM, need to be read
into system memory, which is a very expensive operation.</p>
<p>To limit the impact of unaccelerated rendering to VRAM-based
surfaces, there exists a punting mechanism, which moves the surface
which is detected to be often read from to the system memory. If
the surface is found to be copied from often enough, it may be
promoted back to the video memory.</p>
<p>On certain video boards/drivers combinations the system-memory
based DirectDraw surfaces are known to cause rendering artifacts
and other issues. The DirectDraw pipeline provides a way to disable
the punting mechanism so that the system memory surfaces are not
used.</p>
<p>To defeat the built-in surface punting mechanism provide the
following flag to the Java VM:
<tt>-Dsun.java2d.ddforcevram=true</tt>. Note that this can result
in performance degradation, as the software loops may be reading
pixels from VRAM on each operation. In this case you may consider
disabling the DirectDraw pipeline (see above).</p>
<a name="gcgsz" id="gcgsz"></a>
<h5>3.1.3.4 Disabling the DirectDraw Blit Operations</h5>
<p>In a blit operation (Bit Block Transfer), two bitmap patterns
are combined. This operation basically corresponds to a call to the
<tt>Graphics.drawImage()</tt> API.</p>
<p>In some cases it is possible to avoid rendering problems by
disabling the DirectDraw blit operations. GDI blits will be used
instead. Note that this might result in bad performance. Consider
disabling the DirectDraw pipeline instead.</p>
<p>To disable the use of DirectDraw blit operations, pass the
parameter <tt>-Dsun.java2d.ddblit=false</tt> to the Java VM.</p>
<a name="gcgsi" id="gcgsi"></a>
<h4>3.1.4 Windows OS: Using Direct3D Pipeline (Full-Screen
Mode)</h4>
<p>Starting with the Java SE 6 release, the Direct3D pipeline uses
the Direct3D API for rendering. This pipeline is enabled in
full-screen mode by default, if the drivers support the required
features and the level of rendering quality.</p>
<p>With both the Java SE 5 and later releases, it is possible to
enable the Direct3D pipeline or to force its use, as described in
the subsections below.</p>
<p>Consider enabling the Direct3D pipeline for your application if
it makes heavy use of rendering operations such as alpha
compositing, antialiasing, and transforms.</p>
<p>However, use caution when deciding to enable this pipeline in
your application. For example, some built-in video chipsets (which
are used in most notebooks) do not perform well using Direct3D,
even if they satisfy the quality requirements for Java 2D
pipelines.</p>
<a name="gcgsp" id="gcgsp"></a>
<h5>3.1.4.1 Disabling the Direct3D Pipeline</h5>
<p>Some older video boards/drivers combinations are known to cause
issues (both rendering and performance) with the Direct3D pipeline.
To disable the pipeline in such cases, with Java SE 5 and later
releases, pass the parameter <tt>-Dsun.java2d.d3d=false</tt> to the
Java VM, or set the <tt>J2D_D3D</tt> environment variable to
<tt>false</tt>.</p>
<a name="gcgsn" id="gcgsn"></a>
<h5>3.1.4.2 Forcing the Use of the Direct3D Pipeline</h5>
<p>With Java SE 5 and later releases, to enable the Direct3D
pipeline in both windowed and full-screen mode, use the parameter
<tt>-Dsun.java2d.d3d=true</tt>, or set the <tt>J2D_D3D</tt>
environment variable to <tt>true</tt>. Note that the pipeline is
enabled only if the drivers support minimum required features.</p>
<a name="gcgtn" id="gcgtn"></a>
<h5>3.1.4.3 Diagnosing Rendering Problems with Direct3D
Pipeline</h5>
<p>With the Java SE 6 release, some rendering issues (like missing
pixels, garbled rendering) can be diagnosed by forcing different
Direct3D rasterizers. Set the <tt>J2D_D3D_RASTERIZER</tt>
environment variable to one of the following: <tt>ref</tt>,
<tt>rgb</tt>, <tt>hal</tt>, or <tt>tnl</tt>.</p>
<p>Refer to Direct3D documentation for a description of these
rasterizers. By default the best rasterizer is chosen based on its
advertised capabilities. In particular, the <tt>ref</tt> rasterizer
forces the use of the reference Direct3D rasterizer from Microsoft.
If a rendering problem is not reproducible with this rasterizer,
then it is very likely to be a video driver bug.</p>
<p>The <tt>rgb</tt> rasterizer is available only if the Direct3D
SDK is installed. This SDK can be obtained from <a href=
"http://msdn.microsoft.com/directx/">Microsoft Game Technologies
Center</a>.</p>
<p>For performance or quality problems with text rendering with the
Direct3D pipeline, you can force the use of ARGB texture instead of
the default Alpha texture for the Direct3D pipeline's glyph cache.
To do this, set the <tt>J2D_D3D_NOALPHATEXTURE</tt> environment
variable to <tt>true</tt>.</p>
<a name="gcgto" id="gcgto"></a>
<h4>3.1.5 Using OpenGL Pipeline (SolarisOS, Linux, and
Windows)</h4>
<p>The OpenGL pipeline was first made available in the J2SE 5.0
release on Solaris OS, Linux, and Windows. This alternate pipeline
uses the hardware-accelerated, cross-platform OpenGL API when
rendering to <tt>VolatileImages</tt>, to backbuffers created with
<tt>BufferStrategy</tt> API, and to the screen.</p>
<p>This pipeline can offer great performance advantages over the
default (X11 or GDI/DirectDraw) pipelines for certain applications.
Consider enabling the pipeline for your application if it makes
heavy use of rendering operations like alpha compositing,
antialiasing, and transforms.</p>
<p>For a complete list of Java 2D operations that are accelerated
by the OpenGL pipeline, refer to the article <a href=
"http://today.java.net/cs/user/print/a/147">Behind the Graphics2D:
The OpenGL-based Pipeline</a>.</p>
<a name="gdpji" id="gdpji"></a>
<h5>3.1.5.1 Enabling the OpenGL Pipeline</h5>
<p>The OpenGL pipeline is currently disabled by default. To attempt
to enable the OpenGL pipeline, provide the following option to the
JVM:</p>
<p><tt>-Dsun.java2d.opengl=true</tt></p>
<p>To receive verbose console output about whether the OpenGL
pipeline is initialized successfully for a particular screen, set
the option to <tt>True</tt> (note the uppercase
&#8220;T&#8221;):</p>
<p><tt>-Dsun.java2d.opengl=True</tt></p>
<a name="gdpie" id="gdpie"></a>
<h5>3.1.5.2 Minimum Requirements</h5>
<p>The OpenGL pipeline will not be enabled if the hardware or
drivers do not meet the minimum requirements. If for some reason
one of the following requirements is not met, Java 2D will fall
back and use the default pipeline (X11 on Solaris/Linux,
GDI/DirectDraw on Windows), which means your application will
continue to work correctly, but without the OpenGL
acceleration.</p>
<p>The minimum requirements for Solaris OS and Linux are the
following:</p>
<ul>
<li>
<p>Hardware accelerated OpenGL/GLX libraries installed and
configured properly</p>
</li>
<li>
<p>OpenGL version 1.2 or higher</p>
</li>
<li>
<p>GLX version 1.3 or higher</p>
</li>
<li>
<p>At least one TrueColor visual with an available depth buffer</p>
</li>
</ul>
<p>The minimum requirements for Windows OS are the following:</p>
<ul>
<li>
<p>Hardware accelerated drivers supporting the extensions
<tt>WGL_ARB_pbuffer</tt>, <tt>WGL_ARB_render_texture</tt>, and
<tt>WGL_ARB_pixel_format</tt></p>
</li>
<li>
<p>OpenGL version 1.2 or higher</p>
</li>
<li>
<p>At least one pixel format with an available depth buffer</p>
</li>
</ul>
<a name="gdphy" id="gdphy"></a>
<h5>3.1.5.3 Latest OpenGL Drivers</h5>
<p>Since the OpenGL pipeline relies heavily on the OpenGL API and
the underlying graphics hardware and drivers, it is very important
to ensure that you have the latest graphics drivers installed on
your machine. Drivers can be downloaded from your graphics card
manufacturer's web site, as shown in the following table.</p>
<table border="0" cellpadding="0" cellspacing="0" class="dkgrey1"
width="100%">
<tr>
<td>
<table border="0" cellpadding="0" cellspacing="1" width="100%"
class="vatop">
<col width="15%" />
<col width="20%" />
<col width="25%" />
<col width="40%" />
<tr>
<th class="columncaption" align="left" valign="top">
<div class="headerpadding">Manufacturer</div>
</th>
<th class="columncaption" align="left" valign="top">
<div class="headerpadding">Web Site</div>
</th>
<th class="columncaption" align="left" valign="top">
<div class="headerpadding">Platforms</div>
</th>
<th class="columncaption" align="left" valign="top">
<div class="headerpadding">Cards Known to Work</div>
</th>
</tr>
<tr class="yellow2">
<td align="left" valign="top">
<div class="pad5x10">ATI</div>
</td>
<td align="left" valign="top">
<div class="pad5x10"><a href=
"http://ati.com">http://ati.com</a></div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Linux, Windows</div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Radeon 8500 and above, FireGL series</div>
</td>
</tr>
<tr class="yellow2">
<td align="left" valign="top">
<div class="pad5x10">Nvidia</div>
</td>
<td align="left" valign="top">
<div class="pad5x10"><a href=
"http://nvidia.com">http://nvidia.com</a></div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Solaris OS on x64, Linux, Windows</div>
</td>
<td align="left" valign="top">
<div class="pad5x10">GeForce 2 series and above, Quadro FX series
and above</div>
</td>
</tr>
<tr class="yellow2">
<td align="left" valign="top">
<div class="pad5x10">Sun</div>
</td>
<td align="left" valign="top">
<div class="pad5x10"><a href=
"http://sun.com">http://sun.com</a></div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Solaris OS on SPARC</div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Expert3D series, XVR-500, XVR-600, XVR-1200,
XVR-2500</div>
</td>
</tr>
<tr class="yellow2">
<td align="left" valign="top">
<div class="pad5x10">Xi Graphics</div>
</td>
<td align="left" valign="top">
<div class="pad5x10"><a href=
"http://xig.com">http://xig.com</a></div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Solaris OS on x86, Linux</div>
</td>
<td align="left" valign="top">
<div class="pad5x10">Various (check with Xi Graphics)</div>
</td>
</tr>
</table>
</td>
</tr>
</table>
<a name="gdpit" id="gdpit"></a>
<h5>3.1.5.4 Diagnosing Startup Issues</h5>
<p>As mentioned above, the OpenGL pipeline might not be enabled on
certain machines for various reasons. For example, the drivers
might not be properly installed and might report an insufficient
version number. Alternatively, your machine might have an older
graphics card that does not support the appropriate OpenGL version
or extensions.</p>
<p>In the Java SE 6 and later releases, you can get detailed
information about the startup procedures of the OpenGL-based Java
2D pipeline by using the <tt>J2D_TRACE_LEVEL</tt> environment
variable as follows.</p>
<p>On Windows:</p>
<pre>
# set J2D_TRACE_LEVEL=4
# java -Dsun.java2d.opengl=True YourApp
</pre>
<p>On Solaris OS and Linux:</p>
<pre>
# export J2D_TRACE_LEVEL=4
# java -Dsun.java2d.opengl=True YourApp
</pre>
<p>The output will be different depending on your platform and the
installed graphics hardware, but it can give you some insight into
the reasons why the OpenGL pipeline is not being successfully
enabled for your configuration. Note that this output is especially
useful when filing bug reports intended for the Java 2D team at
Sun, as discussed below.</p>
<a name="gdpio" id="gdpio"></a>
<h5>3.1.5.5 Diagnosing Rendering and Performance Issues</h5>
<p>Since the OpenGL pipeline relies so heavily on the underlying
graphics hardware and drivers, it might sometimes be difficult to
determine whether rendering or performance issues are being caused
by Java 2D or by the OpenGL drivers.</p>
<p>One feature new to the OpenGL pipeline in the Java SE 6 release
is the use of the <tt>GL_EXT_framebuffer_object</tt> extension,
which provides better performance for rendering and reduced VRAM
consumption when using <tt>VolatileImages</tt>. This
&#8220;FBO&#8220; codepath is enabled by default when the OpenGL
pipeline is enabled, but only if your graphics hardware and driver
support this OpenGL extension. This extension is generally
available on Nvidia GeForce/Quadro FX series and newer, and on ATI
Radeon 9500 and newer. If you suspect that the &#8220;FBO&#8221;
codepath is causing problems in your application, you can disable
it by setting the following system property:</p>
<p><tt>-Dsun.java2d.opengl.fbobject=false</tt></p>
<p>Setting this property will cause Java 2D to fall back on the
older &#8220;pbuffer-based&#8221; codepath.</p>
<p>If you find that a certain Java 2D operation causes different
visual results with the OpenGL pipeline enabled than without, it
probably indicates a graphics driver bug. Similarly, if the
performance of Java 2D rendering is significantly worse with the
OpenGL pipeline enabled than without, it is most likely caused by a
driver or hardware problem.</p>
<p>In either case, file a detailed bug report through the normal
bug reporting channels (see <img class="linkicon" src=
"graphics/linkicon.gif" /><a href="bugreports.html">Chapter&#160;8,
Submitting Bug Reports</a>). When filing bug reports, be as
detailed as possible, and always include the following
information:</p>
<ul>
<li>
<p>Operating system (for example, Ubuntu Linux 6.06, Windows XP
SP2)</p>
</li>
<li>
<p>Name of graphics hardware manufacturer and device (for example,
Nvidia GeForce? 2 MX 440)</p>
</li>
<li>
<p>Exact driver version (for example, ATI Catalyst 6.8, Nvidia
91.33)</p>
</li>
<li>
<p>Output when <tt>J2D_TRACE_LEVEL=4</tt> is specified on the
command line (as described in previous section)</p>
</li>
<li>
<p>If on Solaris OS or Linux, the output of the <tt>glxinfo</tt>
command</p>
</li>
</ul>
<a name="gcrua" id="gcrua"></a>
<h3>3.2 Generic Performance Issues</h3>
<p>This section contains the following subsections:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrtt">3.2.1 Hardware Accelerated Rendering Primitives</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrus">3.2.2 Using Java 2D Primitive Tracing to Detect and Avoid
Non-accelerated Rendering</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gduem">3.2.3 Causes of Poor Rendering Performance</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrwc">3.2.4 Improving Performance of Software-only
Rendering</a></p>
</li>
</ul>
<a name="gcrtt" id="gcrtt"></a>
<h4>3.2.1 Hardware Accelerated Rendering Primitives</h4>
<p>In order to better understand what could be causing performance
problems, take a look at what hardware acceleration means.</p>
<p>In general, hardware accelerated rendering could be divided into
two categories.</p>
<ul>
<li>
<p>Hardware-accelerated rendering to an &#8220;accelerated&#8221;
destination. Examples of rendering destinations which can be
hardware-accelerated are <tt>VolatileImage</tt>, <tt>screen</tt>,
and <tt>BufferStrategy</tt>. If a destination is accelerated,
rendering which goes to such surface may be performed by video
hardware. So if you issue a <tt>drawRect</tt> call, Java 2D
redirects this call to the underlying native API (such as GDI,
DirectDraw, Direct3D or OpenGL, or X11), which performs the
operation using hardware.</p>
</li>
<li>
<p>Caching images in accelerated memory (Video memory or pixmaps)
so that they can be copied very fast to another accelerated
surface. Such images are known as &#8220;managed images.&#8221;</p>
</li>
</ul>
<p>Ideally, all operations performed to an accelerated surface are
hardware-accelerated. In this case the application takes the full
advantage that is offered by the platform.</p>
<p>Unfortunately in many cases the default pipelines are not able
to use the hardware for rendering. This can happen due to the
pipeline limitations, or the underlying native API. For example,
most X servers do not support rendering antialiased primitives, or
alpha compositing.</p>
<p>One cause of performance issues is when operations performed are
not hardware-accelerated. Even in cases when a destination surface
is accelerated, some primitives may not be.</p>
<p>It is important to know how to detect the cases when hardware
acceleration is not being used. Knowing this may help in improving
performance.</p>
<a name="gcrus" id="gcrus"></a>
<h4>3.2.2 Using Java 2D Primitive Tracing to Detect and Avoid
Non-accelerated Rendering</h4>
<p>To detect a non-accelerated rendering, you can use Java 2D
primitive tracing.</p>
<p>Java 2D has built-in primitive tracing. See the description of
the <tt>trace</tt> property at <a href=
"http://download.oracle.com/javase/7/docs/technotes/guides/2d/flags.html">
System Properties for Java 2D Technology</a>.</p>
<p>Run your application with <tt>-Dsun.java2d.trace=count</tt>.
When the application exits, a list of primitives and their counts
is printed to the console.</p>
<p>Any time you see a <tt>MaskBlit</tt> or any of the
<tt>General*</tt> primitives, it typically means that some of your
rendering is going through software loops. Here is the output from
performing <tt>drawImage</tt> on a translucent
<tt>BufferedImage</tt> to a <tt>VolatileImage</tt> on Linux:</p>
<p><tt>sun.java2d.loops.Blit$GeneralMaskBlit::Blit(IntArgb,
SrcOverNoEa, "Integer BGR
Pixmap")sun.java2d.loops.MaskBlit::MaskBlit(IntArgb, SrcOver,
IntBgr)</tt></p>
<p>Here are some of the common non-accelerated primitives in the
default pipelines, and their signatures in the tracing output. Note
that most of this tracing was taken on Linux; you may see some
differences depending on your platform and configuration.</p>
<ul>
<li>
<p>Translucent images (Images with
<tt>ColorModel.getTranslucency()</tt> returns
<tt>Translucency.TRANSLUCENT</tt>), or with
<tt>AlphaCompositing</tt>. Sample primitive tracing output:</p>
<p>
<tt>sun.java2d.loops.Blit$GeneralMaskBlit::Blit(IntArgb,SrcOverNoEa,
"Integer BGR Pixmap")sun.java2d.loops.MaskBlit::MaskBlit(IntArgb,
SrcOver, IntBgr)</tt></p>
</li>
<li>
<p>Use of antialiasing (by setting the antialiasing hint). Sample
primitive tracing output:</p>
<p><tt>sun.java2d.loops.MaskFill::MaskFill(AnyColor, Src,
IntBgr)</tt></p>
</li>
<li>
<p>Rendering antialiased text (setting the text antialising hint).
Sample output can be one of the following:</p>
<ul>
<li>
<p>
<tt>sun.java2d.loops.DrawGlyphListAA::DrawGlyphListAA(OpaqueColor,
SrcNoEa, AnyInt)</tt></p>
</li>
<li>
<p>
<tt>sun.java2d.loops.DrawGlyphListLCD::DrawGlyphListLCD(AnyColor,
SrcNoEa, IntBgr)</tt></p>
</li>
</ul>
</li>
<li>
<p>Alpha compositing, either by rendering with translucent Color (a
Color with alpha value which is not <tt>0xff</tt>), or by setting a
non-default <tt>AlphaCompositing</tt> mode with
<tt>Graphics2D.setComposite()</tt>:</p>
<p><tt>sun.java2d.loops.Blit$GeneralMaskBlit::Blit(IntArgb,
SrcOver, IntRgb)sun.java2d.loops.MaskBlit::MaskBlit(IntArgb,
SrcOver, IntRgb)</tt></p>
</li>
<li>
<p>Non-trivial transforms (if the transform is more than only
translation). Rendering a transformed opaque image to a
<tt>VolatileImage</tt>:</p>
<p><tt>sun.java2d.loops.TransformHelper::TransformHelper(IntBgr,
SrcNoEa, IntArgbPre)</tt></p>
</li>
<li>
<p>Rendering a rotated line:</p>
<p><tt>sun.java2d.loops.DrawPath::DrawPath(AnyColor, SrcNoEa,
AnyInt)</tt></p>
</li>
</ul>
<p>Run your application with the tracing and make sure you do not
use unaccelerated primitives unless they are needed.</p>
<a name="gduem" id="gduem"></a>
<h4>3.2.3 Causes of Poor Rendering Performance</h4>
<p>Some of the possible causes of poor rendering performance are
described in the following subsections:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrvb">3.2.3.1 Mixing Accelerated and Non-accelerated
Rendering</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrvp">3.2.3.2 Using Non-optimal Rendering Primitives</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrvj">3.2.3.3 Using Heap-based Destination Surface (a
<tt>BufferedImage</tt>)</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrwz">3.2.3.4 Defeating Built-in Acceleration Mechanisms</a></p>
</li>
</ul>
<a name="gcrvb" id="gcrvb"></a>
<h5>3.2.3.1 Mixing Accelerated and Non-accelerated Rendering</h5>
<p>A situation when only part of the primitives rendered by an
application could be accelerated by the particular pipeline when
rendering to an accelerated surface can cause thrashing, because
the pipelines will be constantly trying to adjust for better
rendering performance but with possibly little success.</p>
<p>If it is known beforehand that most of the rendering primitives
will not be accelerated, it could be better to either render to a
<tt>BufferedImage</tt> and then copy it to the back-buffer or the
screen, or switch to a non-hardware accelerated pipeline using one
of the flags discussed above.</p>
<p>Note, however, that this approach may limit your application's
ability to take advantage of future improvements in Java 2D's use
of hardware acceleration.</p>
<p>For example, if your application is often used in remote X
server cases, but it heavily uses antialiasing, alpha compositing,
and so forth, the performance can be severely degraded. To avoid
this, disable the use of Pixmaps by setting the
<tt>-Dsun.java2d.pmoffscreen=false</tt> property either by passing
it to the Java runtime, or by setting it programmatically using the
<tt>System.setProperty()</tt> API. Note that this property must be
set prior to any GUI-related operations because it is read only
once.</p>
<a name="gcrvp" id="gcrvp"></a>
<h5>3.2.3.2 Using Non-optimal Rendering Primitives</h5>
<p>It is preferable to use the simplest primitive possible to
achieve the desired visual effect.</p>
<p>For example, use <tt>Graphics.drawLine()</tt>instead of <tt>new
Line2D().draw()</tt>. The result looks the same. However, the
second operation is much more computationally-intensive because it
is rendered as a generic shape, which is typically much more
expensive to render. Shapes show up in different ways in the
primitive tracing, depending on antialiasing settings and the
specific pipeline, but most likely they will show up as many
<tt>*FillSpans</tt> or <tt>DrawPath</tt> primitives.</p>
<p>Another example of complicated attributes is
<tt>GradientPaint</tt>. Although it may be hardware accelerated by
some of the non-default pipelines (such as <tt>OpenGL</tt>), it is
not hardware accelerated by the default pipelines. Therefore, you
can restrict the use of <tt>GradientPaint</tt> if it causes
performance problems.</p>
<a name="gcrvj" id="gcrvj"></a>
<h5>3.2.3.3 Using Heap-based Destination Surface (a
<tt>BufferedImage</tt>)</h5>
<p>Rendering to a <tt>BufferedImage</tt> almost always uses
software loops.</p>
<p>An exception is that on some SPARC systems the VIS instruction
set may be used for accelerating certain imaging operations. Refer
to <a href="http://www.sun.com/processors/vis/">web site for the
VIS Instruction Set</a>.</p>
<p>To ensure that the rendering has the opportunity of being
hardware accelerated, choose a <tt>BufferStrategy</tt> or a
<tt>VolatileImage</tt> object as the rendering destination.</p>
<a name="gcrwz" id="gcrwz"></a>
<h5>3.2.3.4 Defeating Built-in Acceleration Mechanisms</h5>
<p>Java 2D attempts to accelerate certain types of images. Contents
of images may be cached in video memory for faster copying to
accelerated destinations such as <tt>VolatileImages</tt>. These
mechanisms can be unknowingly defeated by the application, for
example, in the following cases:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrwq">Getting Direct Access to the Pixels with
<tt>getDataBuffer()</tt></a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrvk">Rendering to a Sprite Before Every Copy</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrvt">Exhausting Accelerated Memory Resources</a></p>
</li>
</ul>
<a name="gcrwq" id="gcrwq"></a>
<h5>Getting Direct Access to the Pixels with
<tt>getDataBuffer()</tt></h5>
<p>If an application gets access to <tt>BufferedImage</tt> pixels
by using the <tt>getRaster().getDataBuffer()</tt> API, Java 2D will
not be able to guarantee that the data in the cache is up to date,
so it will disable any acceleration attempts of such image.</p>
<p>There are two ways to avoid this problem:</p>
<ul>
<li>
<p>If possible, do not call <tt>getDataBuffer()</tt>. Instead, work
with <tt>WriteableRaster</tt>, which can be obtained with the
<tt>BufferedImage.getRaster()</tt> method.</p>
</li>
<li>
<p>If you do need to modify the pixels directly, you can manually
cache your image in video memory by maintaining the cached copy of
your image in a <tt>VolatileImage</tt>, and updating the cached
data when the original image is touched.</p>
</li>
</ul>
<a name="gcrvk" id="gcrvk"></a>
<h5>Rendering to a Sprite Before Every Copy</h5>
<p>If an application renders to an image every time before copying
it to an accelerated surface (<tt>VolatileImage</tt>,
<tt>BufferStrategy</tt>), the image cannot take advantage of being
cached in accelerated memory. This is because the cached copy has
to be updated every time the original image is updated, and
therefore only the default system-memory based surface is used, and
this means no acceleration.</p>
<a name="gcrvt" id="gcrvt"></a>
<h5>Exhausting Accelerated Memory Resources</h5>
<p>If the application uses many images, it may exhaust the
available accelerated memory. If this is indeed the cause of
performance issues for your application, you might need to handle
the resources.</p>
<p>The following API can be used to request the amount of available
accelerated memory:
<tt>GraphicsDevice.getAvailableAcceleratedMemory()</tt>.</p>
<p>In addition, the following API can be used to determine if your
image is being accelerated: <tt>Image.getCapabilities()</tt>.</p>
<p>If you determined that your application is exhausting the
resources, you can handle the problem in the following ways:</p>
<ul>
<li>
<p>Do not hold images you no longer need. For example, if your game
advanced to the next level, release all images from the previous
levels. You can also release accelerated resources associated with
an image by using the <tt>Image.flush()</tt> API.</p>
</li>
<li>
<p>Use the acceleration priority API
<tt>Image.getAccelerationPriority()</tt> and
<tt>setAccelerationPriority()</tt> to specify the acceleration
priority for your images. It is a good idea to make sure that at
least your back-buffer is accelerated, so create it first, and with
acceleration priority of 1 (default). You can also prohibit certain
images from being accelerated if needed by setting the acceleration
priority to 0.0.</p>
</li>
</ul>
<a name="gcrwc" id="gcrwc"></a>
<h4>3.2.4 Improving Performance of Software-only Rendering</h4>
<p>If your application relies on software-only rendering (by only
rendering to a <tt>BufferedImage</tt>, or changing the default
pipeline to an unaccelerated one), or even if it does mixed
rendering, there are certain approaches to improving
performance:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrws">3.2.4.1 Use of Image Types or Operations With Optimized
Support</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gcrwh">3.2.4.2 Transparency vs Translucency</a></p>
</li>
</ul>
<a name="gcrws" id="gcrws"></a>
<h5>3.2.4.1 Use of Image Types or Operations With Optimized
Support</h5>
<p>Due to overall platform size constraints, Java 2D has a limited
number of optimized routines for converting from one image format
to another. In situations where an optimized direct loop can not be
found, Java 2D will do the conversion through an intermediate image
format (<tt>IntArgb</tt>). This results in performance
degradation.</p>
<p>Java 2D primitive tracing can be used for detecting such
situations.</p>
<p>For each <tt>drawImage</tt> call there will be two primitives:
the first one converting the image from the source format to an
intermediate <tt>IntArgb</tt> format and the second one converting
from intermediate <tt>IntArgb</tt> to the destination format.</p>
<p>Here are two ways to avoid such situations:</p>
<ul>
<li>
<p>Use a different image format if possible.</p>
</li>
<li>
<p>Convert your image to an intermediate image of one of the
better-supported formats, such as <tt>INT_RGB</tt> or
<tt>INT_ARGB</tt>. In this way the conversion from the custom image
format will happen only once instead of on every copy.</p>
</li>
</ul>
<a name="gcrwh" id="gcrwh"></a>
<h5>3.2.4.2 Transparency vs Translucency</h5>
<p>Consider using 1-bit transparent (<tt>BITMASK</tt>) images for
your sprites as opposed to images with full translucency (such as
<tt>INT_ARGB</tt>) if possible.</p>
<p>Processing images with full alpha is more CPU-intensive.</p>
<p>You can get a 1-bit transparent image using a call to
<tt>GraphicsConfiguration.createCompatibleImage(w,h,
Transparency.BITMASK)</tt>.</p>
<a name="gdlvo" id="gdlvo"></a>
<h3>3.3 Text-Related Issues</h3>
<p>This section describes some issues that can be related to text
rendering, included in the following subsections:</p>
<ul>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gdlwj">3.3.1 Application Crash During Text Rendering</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gdlwn">3.3.2 Differences in Text Appearance</a></p>
</li>
<li>
<p><img class="linkicon" src="graphics/linkicon.gif" /><a href=
"#gdpin">3.3.3 Metrics</a></p>
</li>
</ul>
<a name="gdlwj" id="gdlwj"></a>
<h4>3.3.1 Application Crash During Text Rendering</h4>
<p>If an application crashes during text rendering, first check the
fatal error log file. See <img class="linkicon" src=
"graphics/linkicon.gif" /><a href="felog.html">Appendix&#160;B,
Fatal Error Log</a> for detailed information about this error log
file. If the crash occurred in <tt>fontmanager.dll</tt> or if
<tt>fontmanager</tt> is present in the stack, then the crash
occurred in the font processing code. Here is an example of typical
native stack frames (excerpt from the full log file).</p>
<pre>
Stack: [0x008a0000,0x008f0000),  sp=0x008ef52c,  free space=317k
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)
C  [ntdll.dll+0x1888f]
C  [ntdll.dll+0x18238]
C  [ntdll.dll+0x11c76]
C  [MSVCR71.dll+0x16b3]
C  [MSVCR71.dll+0x16db]
C  [fontmanager.dll+0x21f9a]
C  [fontmanager.dll+0x22876]
C  [fontmanager.dll+0x1de40]
C  [fontmanager.dll+0x1da94]
C  [fontmanager.dll+0x48abb]
j  sun.font.FileFont.getGlyphImage(JI)J+0
j  sun.font.FileFontStrike.getGlyphImagePtrs([I[JI)V+92
j  sun.font.GlyphList.mapChars(Lsun/java2d/loops/FontInfo;I)Z+37
j  sun.font.GlyphList.setFromString(Lsun/java2d/loops/FontInfo;Ljava/lang/String;FF)Z+71
j  sun.java2d.pipe.GlyphListPipe.drawString(Lsun/java2d/SunGraphics2D;Ljava/lang/String;DD)V+148
j  sun.java2d.SunGraphics2D.drawString(Ljava/lang/String;II)V+60
j  FontCrasher.tryFont(Ljava/lang/String;)V+138
j  FontCrasher.main([Ljava/lang/String;)V+20
v  ~StubRoutines::call_stub
</pre>
<p>In this case, a particular font is probably the problem. If so,
then removing this font from the system will likely resolve the
problem.</p>
<p>To identify the font file, execute the application with
<tt>-Dsun.java2d.debugfonts=true</tt>. The font that is mentioned
last is usually the one that is causing problems. Here is an
example of typical output.</p>
<pre>
INFO: Registered file C:\WINDOWS\Fonts\WINGDING.TTF as font ** TrueType Font: Family=Wingdings
 Name=Wingdings style=0 fileName=C:\WINDOWS\Fonts\WINGDING.TTF rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file SYMBOL.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager addToFontList
INFO: Add to Family Symbol, Font Symbol rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager registerFontFile
INFO: Registered file C:\WINDOWS\Fonts\SYMBOL.TTF as font ** TrueType Font: Family=Symbol
 Name=Symbol style=0 fileName=C:\WINDOWS\Fonts\SYMBOL.TTF rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager findFont2D
INFO: Search for font: Dialog
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file ARIALBD.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager addToFontList
INFO: Add to Family Arial, Font Arial Bold rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager registerFontFile
INFO: Registered file C:\WINDOWS\Fonts\ARIALBD.TTF as font ** TrueType Font: Family=Arial
 Name=Arial Bold style=1 fileName=C:\WINDOWS\Fonts\ARIALBD.TTF rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file WINGDING.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file SYMBOL.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager findFont2D
INFO: Search for font: Dialog
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file ARIAL.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager addToFontList
INFO: Add to Family Arial, Font Arial rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager registerFontFile
INFO: Registered file C:\WINDOWS\Fonts\ARIAL.TTF as font ** TrueType Font: Family=Arial
 Name=Arial style=0 fileName=C:\WINDOWS\Fonts\ARIAL.TTF rank=2
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file WINGDING.TTF
Aug 16, 2006 10:59:06 PM sun.font.FontManager initialiseDeferredFont
INFO: Opening deferred font file SYMBOL.TTF
</pre>
<div class="note">
<hr />
<p><b>Note -</b> In some cases the font that is last mentioned
might be in fact innocent. Font names are printed when they are
first used and subsequent uses are not shown.</p>
<hr /></div>
<p>To verify that this particular font is causing the problem, you
can temporarily remove it from your system. You can easily find the
file name associated with this particular family name from the
above output.</p>
<p>Another verification approach is to use the Font2DTest tool
(<tt>demo/jfc/Font2DTest</tt>) to test fonts that you suspect. You
can specify a particular font size, style, and rasterization mode.
If the process of viewing a particular font with Font2DTest causes
the JDK to crash, then it is very likely that it is the font that
is causing the problems.</p>
<p>If you found a font causing the JDK to crash, it is very
important to report this problem, including the particular font and
the operating system, at <tt>bugs.sun.com</tt>. See <img class=
"linkicon" src="graphics/linkicon.gif" /><a href=
"bugreports.html">Chapter&#160;8, Submitting Bug Reports</a> for
more information about reporting bugs.</p>
<a name="gdlwn" id="gdlwn"></a>
<h4>3.3.2 Differences in Text Appearance</h4>
<p>Java has its own font rasterizer, and you can expect some small
differences between the appearance of text in a Java application
and in a native application.</p>
<p>One of the most typical sources of these differences is that the
antialiasing settings can be different. In particular, a Swing
application sometimes ignores the Linux desktop font antialiasing
settings.</p>
<p>There are several likely reasons for this behavior:</p>
<ul>
<li>
<p>Over remote X11 antialiasing is not enabled by default for
performance reasons. For information about how to force
antialiasing, see the <a href=
"http://www.oracle.com/technetwork/java/index-137037.html#Font_and_Text_questions">
Font and Test questions in the Java 2D FAQ</a>.</p>
</li>
<li>
<p>CJK fonts that use embedded bitmaps may render using the bitmaps
instead of subpixel text.</p>
</li>
<li>
<p>Some variants of unsupported desktops do not report their font
smoothing settings properly. For example, KDE is unsupported but
should generally work; however, some problem seems to prevent JDK
from picking up the setting.</p>
</li>
</ul>
<p>The best way to ensure that the configuration is what you expect
is to run Font2DTest, explicitly select the font used by the native
application, and set other parameters as appropriate. Here is a
sample screen from the Font2DTest tool.</p>
<a name="gdpkv" id="gdpkv"></a>
<h6 class="figuretitle">Sample Screen from Font2DTest Tool</h6>
<img src="figures/Font2DTest.gif" alt=
"Sample screen from the Font2DTest tool" title=
"Sample screen from the Font2DTest tool" width="869" height=
"411" />
<p>Hint: you can input your own string by choosing &#8220;user
text&#8221; in the drop-down menu labelled &#8220;Text to
use.&#8221;</p>
<p>The size of the font in the Java language is always expressed
with 72 dpi. A native OS can use a different screen dpi, and
therefore an adjustment needs to be made. Matching Java font size
can be calculated as <tt>Toolkit.getScreenResolution()</tt> divided
by 72 multiplied by the size of the native font.</p>
<p>In all &#8220;native&#8221; Swing look and feels, such as the
Windows look and feel or the GTK look and feel (for Solaris OS and
Linux), Swing components perform this adjustment automatically1,
but if you are running Font2DTest, the text display area will
always use 72 dpi.</p>
<p>On operating systems other than Windows, the general
recommendation is to use TrueType fonts instead of Type1 fonts. The
easiest way to discover the type of font is to look at the file
extension: extensions <tt>pfa</tt> and <tt>pfb</tt> indicate Type1
fonts, and <tt>ttf</tt>, <tt>ttc</tt>, and <tt>tte</tt> represent
TrueType fonts.</p>
<a name="gdpin" id="gdpin"></a>
<h4>3.3.3 Metrics</h4>
<p>If you find that text bounds are different from what you expect,
ensure that you are using the appropriate way to calculate them.
For example, the height obtained from a <tt>FontMetrics</tt> is not
specific to a particular piece of text and the <tt>stringWidth</tt>
indicates logical advance, which is not the same thing as
&#8220;width.&#8221; For more details, refer to the <a href=
"http://www.oracle.com/technetwork/java/index-137037.html#Font_and_Text_questions">
Font and Text questions in the Java 2D FAQ</a>.</p>
<a name="gceyw" id="gceyw"></a>
<h3>3.4 Java 2D Printing</h3>
<p>This section describes some issues that can arise with Java 2D
printing and suggests causes and solutions.</p>
<p>See also the <a href=
"http://www.oracle.com/technetwork/java/index-137037.html#Printing_questions">
Printing questions in the Java 2D FAQ</a>.</p>
<dl>
<dt><b>Issue: On Windows, JRE crashes during printing.</b></dt>
<dd>
<p><b>Cause:</b> The JRE uses Windows printer drivers and they
might have problems.</p>
<p><b>Solution:</b> Upgrade the Windows printer driver for the
printer that is being used.</p>
</dd>
<dt><b>Issue: On Windows, the printing seems to be successful, but
the job does not print.</b></dt>
<dd>
<p><b>Cause:</b> Some jobs fail to properly spool to the
printer.</p>
<p><b>Solution:</b> In the printer driver properties, disable
Advanced Printing Options.</p>
</dd>
<dt><b>Issue: On Windows, the print dialog takes a long time to
appear.</b></dt>
<dd>
<p><b>Cause:</b> Applications might cause the JRE to probe all
printers, including those that are disconnected.</p>
<p><b>Solution:</b> Look for disconnected or unreachable network
printers and remove them from the list of printers.</p>
</dd>
<dt><b>Issue: On Solaris OS and Linux, PrinterJob.printDialog()
shows the error "No services found".</b></dt>
<dd>
<p><b>Cause:</b> The cause is one of the following:</p>
<ul>
<li>
<p>The <tt>lpc</tt> utility is not in the <tt>/usr/sbin</tt>
directory.</p>
</li>
<li>
<p>The <tt>lpstat</tt> utility is not in the <tt>/usr/sbin</tt>
directory.</p>
</li>
</ul>
<p><b>Solution:</b> Install <tt>lpc</tt> and <tt>lpstat</tt> in the
standard location, as mentioned above.</p>
</dd>
</dl>
</div>
<div class="BottomPageControlPane">
<table class="pagecontrol">
<tr>
<td>
<div class="pagefooterlinks">Copyright &#169;1995, 2011, Oracle
and/or its affiliates. All rights reserved. <a href=
"docinfo.html">Legal Notices</a></div>
</td>
<td class="pagenavlinks"><a href="awt.html"><img src=
"graphics/leftButton.gif" border="0" alt="Previous" title=
"Previous" /></a> <a href="swing.html"><img src=
"graphics/rightButton.gif" border="0" alt="Next" title=
"Next" /></a></td>
</tr>
</table>
</div>
</body>
</html>
